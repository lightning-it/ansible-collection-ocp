---
- name: Get kubeconfig for OCP cluster
  ansible.builtin.include_tasks: cluster_login.yml
  tags:
    - always

- name: Create image tag mirror set
  delegate_to: "{{ ocp_install_delegate_to }}"
  run_once: true
  when:
    - ocp_install_registry is defined
    - ocp_install_registry | bool
  tags:
    - post_install
  block:
    - name: Create image tag mirror set
      kubernetes.core.k8s:
        kubeconfig: "{{ ocp_install_kubeconfig_dir }}/config"
        state: present
        definition: >-
          {{ lookup('template', 'imagemirrors.yml.j2') }}
      register: _ocp_install_set_imagetagmirrorset_results
      loop:
        - kind: ImageTagMirrorSet
          spec: imageTagMirrors
        - kind: ImageDigestMirrorSet
          spec: imageDigestMirrors
